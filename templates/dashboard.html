{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}

<body class="bg-light">
  <div class="container mt-5">

    <!-- DASHBOARD SECTION -->
    <div id="dashboardSection">
      <div class="card shadow">
        <div class="card-header bg-primary text-white">
          <h3 class="mb-0">Welcome, {{ user.name }}!</h3>
        </div>
        <div class="card-body">
          <h5 class="mb-3">Your Personal Details:</h5>
          <ul class="list-group list-group-flush mb-3">
            <li class="list-group-item">Age: {{ user.age }}</li>
            <li class="list-group-item">Weight: {{ user.weight }} kg</li>
            <li class="list-group-item">Height: {{ user.height }} cm</li>
            <li class="list-group-item">Gender: {{ user.gender }}</li>
            <li class="list-group-item">Goal: {{ user.goal }}</li>
          </ul>
          <h5>Your BMR: <span class="badge bg-success">{{ bmr }} kcal/day</span></h5>
        </div>
        <div class="card-footer text-end">
          <a href="/logout" class="btn btn-danger">Logout</a>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="mt-4 text-end">
        <button class="btn btn-outline-primary me-2" onclick="toggleUpdateProfile()">Update Profile</button>
        <form method="POST" action="/delete_profile" style="display:inline;" onsubmit="return confirm('Are you sure? This cannot be undone.')">
          <button type="submit" class="btn btn-outline-danger">Delete My Account</button>
        </form>
      </div>
    </div>

    <!-- UPDATE PROFILE SECTION -->
    <div class="card mt-3" id="updateFormSection" style="display: none;">
      <div class="card-body">
        <h5 class="card-title">Update Profile</h5>
        <form method="POST" action="/update_profile">
          <div class="mb-3">
            <label class="form-label">Name</label>
            <input type="text" class="form-control" name="name" value="{{ user.name }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Age</label>
            <input type="number" class="form-control" name="age" value="{{ user.age }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Weight (kg)</label>
            <input type="number" class="form-control" name="weight" value="{{ user.weight }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Height (cm)</label>
            <input type="number" class="form-control" name="height" value="{{ user.height }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Gender</label>
            <select class="form-select" name="gender" required>
              <option value="Male" {% if user.gender == 'Male' %}selected{% endif %}>Male</option>
              <option value="Female" {% if user.gender == 'Female' %}selected{% endif %}>Female</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Goal</label>
            <input type="text" class="form-control" name="goal" value="{{ user.goal }}" required>
          </div>
          <div class="text-end">
            <button type="submit" class="btn btn-success">Save Changes</button>
            <button type="button" class="btn btn-secondary ms-2" onclick="toggleUpdateProfile()">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <!-- MEAL SUMMARY SECTION -->
    <div class="mt-4">
      <h4>Meal Summary</h4>
      {% if meals %}
        <ul>
          {% for meal in meals %}
            <li>
              <strong>{{ meal['meal'] }}:</strong>
              {{ meal['items'] | join(', ') }}
              <br>
              <em>Logged at: {{ meal['loggedAt'].strftime('%b %d, %Y %I:%M %p') }}</em>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>No meals logged yet.</p>
      {% endif %}
    </div>

  <a class="btn btn-primary mt-2" href="{{ url_for('log_meal') }}">Log New Meal</a>

  </div>

  <!-- JS TOGGLE HANDLERS -->
  <script>
    function toggleUpdateProfile() {
      const dashboard = document.getElementById("dashboardSection");
      const form = document.getElementById("updateFormSection");
      const isFormVisible = form.style.display === "block";
      form.style.display = isFormVisible ? "none" : "block";
      dashboard.style.display = isFormVisible ? "block" : "none";
    }

    function toggleMealForm() {
      const mealForm = document.getElementById("mealForm");
      mealForm.style.display = (mealForm.style.display === "block") ? "none" : "block";
    }

  </script>
</body>

{% endblock %}
